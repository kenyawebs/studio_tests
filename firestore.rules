
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users Collection:
    // 1. Allow reading a user's profile if logged in.
    // 2. Allow creating a profile only if the user is creating their own.
    // 3. Allow updating a profile only if the user is updating their own.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null && request.auth.uid == userId;
    }

    // Prayer Requests Collection:
    // 1. Allow any logged-in user to read requests.
    // 2. Allow any logged-in user to create a request. The userId must match their own.
    // 3. Allow a user to update/delete their own request.
    match /prayerRequests/{requestId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;

      // Distributed Counter Subcollection:
      // Allow any logged-in user to add a shard document to trigger the counter.
      match /counter_shards/{shardId} {
        allow create: if request.auth != null;
      }
    }

    // Posts Collection:
    // 1. Allow any logged-in user to read posts.
    // 2. Allow a logged-in user to create a post, ensuring they are the author.
    // 3. Allow a user to update or delete only their own posts.
    match /posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
  }
}
