
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Users Collection ---
    // A user can create their own document, and can only read or update their own.
    match /users/{userId} {
      allow create, read, update: if request.auth.uid == userId;
    }

    // --- Prayer Requests Collection ---
    // Rules for individual prayer request documents
    match /prayerRequests/{requestId} {
      // A logged-in user can create a prayer request.
      // We should validate that the userId on the new document matches the person creating it.
      allow create: if request.auth.uid == request.resource.data.userId;
      // Any logged-in user can get a single prayer request.
      allow get: if request.auth != null;
    }
    // Rule for querying the entire prayerRequests collection
    match /prayerRequests {
      allow list: if request.auth != null;
    }
    // Allow the Distributed Counter extension to write to its subcollection
    match /prayerRequests/{requestId}/counter_shards/{shardId} {
      allow write: if true;
    }

    // --- Posts Collection (Social Feed) ---
    // Rules for individual post documents
    match /posts/{postId} {
      // A logged-in user can create a post, but only for themselves.
      allow create: if request.auth.uid == request.resource.data.userId;
      // Any logged-in user can get a single post.
      allow get: if request.auth != null;
      // A user can only update or delete their own posts.
      allow update, delete: if request.auth.uid == resource.data.userId;
    }
    // Rule for querying the entire posts collection
    match /posts {
      allow list: if request.auth != null;
    }
  }
}
